# STM32与4G模块通信协议设计

## 1. 协议概述

本协议用于STM32微控制器与4G网络模块之间的串口通信，实现传感器数据的传输和命令交互。协议遵循效率优先、数据包小、可靠性高、实时性好等原则，适用于应急跌落事件监控系统。

## 2. 物理层参数

- **接口类型**：UART（串口）
- **波特率**：115200 bps
- **数据位**：8位
- **停止位**：1位
- **校验位**：无
- **流控**：无

## 3. 数据帧格式

### 3.1 通用帧格式

```
+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+
| 帧头 (2字节)       | 命令码 (1字节)     | 数据长度 (2字节)   | 数据域 (N字节)     | 校验和 (1字节)     | 帧尾 (2字节)       |
+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+
| 0xAA 0x55         | CMD               | LEN               | DATA              | CHECK             | 0x55 0xAA         |
+-------------------+-------------------+-------------------+-------------------+-------------------+-------------------+
```

### 3.2 字段说明  

- **帧头**：固定为0xAA 0x55，用于帧同步
- **命令码**：1字节，用于区分不同的消息类型
- **数据长度**：2字节，标识数据域的字节数（N），范围0-65535
- **数据域**：N字节，消息的实际内容
- **校验和**：1字节，采用异或校验，计算范围为命令码、数据长度、数据域
- **帧尾**：固定为0x55 0xAA，用于帧结束标识

## 4. 命令码定义

| 命令码 | 命令名称 | 方向 | 功能描述 |
|--------|----------|------|----------|
| 0x01   | DATA_UPLOAD | STM32→4G | 传感器数据上传 |
| 0x02   | CONFIG_SET | 4G→STM32 | 配置参数设置 |
| 0x03   | CONFIG_REPLY | STM32→4G | 配置参数回复 |
| 0x04   | HEARTBEAT | STM32→4G | 心跳包 |
| 0x05   | HEARTBEAT_REPLY | 4G→STM32 | 心跳包回复 |
| 0x06   | RESET | 4G→STM32 | 复位命令 |
| 0x07   | RESET_REPLY | STM32→4G | 复位命令回复 |

## 5. 数据类型定义

### 5.1 传感器数据上传帧 (0x01)

传感器数据上传帧支持包含多个传感器数据样本，每个样本的格式如下：

```
+-------------------+-------------------+-------------------+-------------------+-------------------+
| 包序 (1字节)       | 加速度X (2字节)    | 加速度Y (2字节)    | 加速度Z (2字节)    | 角速度X (2字节)    |
+-------------------+-------------------+-------------------+-------------------+-------------------+
| 角速度Y (2字节)    | 角速度Z (2字节)    | 角度X (2字节)      | 角度Y (2字节)      | 角度Z (2字节)      |
+-------------------+-------------------+-------------------+-------------------+-------------------+
| 姿态角1 (2字节)    | 姿态角2 (2字节)    | 气压 (4字节)       | 高度 (4字节)       | 经度 (8字节)       |
+-------------------+-------------------+-------------------+-------------------+-------------------+
| 纬度 (8字节)       |
+-------------------+
```

#### 字段说明
  
- **包序**：1字节，用于标识数据包的序号，范围0~255
- **加速度**：单位mg，范围-32768~32767
- **角速度**：单位°/s，范围-32768~32767
- **角度**：单位°，范围-32768~32767
- **姿态角1**：单位°，范围-32768~32767
- **姿态角2**：单位°，范围-32768~32767
- **气压**：单位Pa，范围0~4294967295
- **高度**：单位m，IEEE 754单精度浮点数，范围±10^38
- **经度**：IEEE 754双精度浮点数，范围-180~180
- **纬度**：IEEE 754双精度浮点数，范围-90~90

#### 数据域格式

数据域可以包含多个传感器数据样本，每个样本的长度固定为47字节（1+2*11+4+4+8*2）。接收方可以根据数据长度字段和样本固定长度计算出样本数量，从而正确解析数据。

### 5.2 配置参数设置帧 (0x02)

```
+-------------------+-------------------+-------------------+
| 采样间隔 (2字节)    | 上报间隔 (2字节)    | 数据格式 (1字节)   |
+-------------------+-------------------+-------------------+
```

#### 字段说明

- **采样间隔**：单位ms，范围10~1000
- **上报间隔**：单位秒，范围1~3600
- **数据格式**：0x01表示二进制格式，0x02表示JSON格式

### 5.3 配置参数回复帧 (0x03)

与配置参数设置帧格式相同，用于回复当前配置。

### 5.4 心跳包 (0x04)

```
+-------------------+
| 设备状态 (1字节)    |
+-------------------+
```

#### 字段说明

- **设备状态**：0x00表示正常，0x01表示异常

### 5.5 心跳包回复 (0x05)

与心跳包格式相同，用于回复设备状态。

### 5.6 复位命令 (0x06)

```
+-------------------+
| 复位类型 (1字节)    |
+-------------------+
```

#### 字段说明

- **复位类型**：0x00表示软复位，0x01表示硬复位

### 5.7 复位命令回复 (0x07)

```
+-------------------+
| 复位状态 (1字节)    |
+-------------------+
```

#### 字段说明

- **复位状态**：0x00表示成功，0x01表示失败

## 6. 通信流程

### 6.1 初始化阶段

1. STM32与4G模块上电后，首先进行硬件初始化
2. STM32发送心跳包(0x04)到4G模块，确认通信链路
3. 4G模块收到心跳包后，回复心跳包回复(0x05)
4. 通信链路建立成功后，进入正常工作阶段

### 6.2 数据上传阶段

1. STM32按采样间隔采集传感器数据
2. 数据经过滑动滤波算法处理
3. 每隔上报间隔，STM32将处理后的传感器数据打包成数据上传帧(0x01)
4. STM32发送数据上传帧到4G模块
5. 4G模块收到数据后，通过MQTT协议发送到云端

### 6.3 配置参数阶段

1. 4G模块发送配置参数设置帧(0x02)到STM32
2. STM32收到配置参数后，更新本地配置
3. STM32发送配置参数回复帧(0x03)到4G模块，确认配置更新

### 6.4 异常处理阶段

1. 当STM32检测到传感器异常或通信链路故障时，发送心跳包(0x04)并设置设备状态为异常(0x01)
2. 4G模块收到异常心跳包后，回复心跳包回复(0x05)
3. 4G模块将异常信息通过MQTT协议发送到云端
4. 云端收到异常信息后，进行相应的处理和报警

## 7. 校验和计算

校验和采用异或校验方法，计算范围包括命令码、数据长度、数据域。计算过程如下：

```c
uint8_t calculate_checksum(uint8_t cmd, uint16_t len, uint8_t* data) {
    uint8_t checksum = cmd;
    checksum ^= (len >> 8) & 0xFF;
    checksum ^= len & 0xFF;
    for (int i = 0; i < len; i++) {
        checksum ^= data[i];
    }
    return checksum;
}
```

## 8. 协议扩展性

- 命令码预留0x08~0xFF供未来扩展使用
- 数据域支持变长格式，可根据命令码动态调整
- 新增数据类型时，可通过命令码和数据长度字段进行识别

## 9. 协议可靠性保证

- 帧同步：通过固定帧头和帧尾进行同步
- 校验和：采用异或校验，防止数据传输错误
- 超时重传：如果发送方在规定时间内未收到回复，进行重传
- 数据缓存：发送方对未确认的数据包进行缓存，以便重传

## 10. 协议兼容性保证

- 协议版本号可通过配置参数进行设置
- 新增字段时，保持原有字段的位置和长度不变
- 接收方对不识别的命令码进行忽略处理

## 11. 协议可测试性保证

- 提供详细的协议文档和测试用例
- 支持通过串口工具进行协议测试
- 发送方和接收方都提供调试接口，便于问题定位和排查
